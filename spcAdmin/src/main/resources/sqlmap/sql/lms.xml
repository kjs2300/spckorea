<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.easycompany.mapper.LmsMapper">

	<select id="contentsList" parameterType="java.util.Map"	resultType="java.util.Map">
		SELECT (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = a.CATEGORY1_KEY) AS CATEGORY1_NAME,
			   (SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = a.CATEGORY2_KEY) AS CATEGORY2_NAME,
			   (SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = a.CATEGORY3_KEY) AS CATEGORY3_NAME,
		       a.EDU_NO, b.EDU_SUB_NO,
		       <![CDATA[
		       CASE WHEN TRAIN_S_DATE > NOW() THEN '교육예정'
					WHEN TRAIN_S_DATE <= NOW() AND TRAIN_E_DATE >= NOW() THEN '교육중'
		            WHEN TRAIN_E_DATE > NOW() THEN '교육종료'
			   END AS EDU_STATUS,
			    ]]>
		       b.EDU_CURR1, b.EDU_CURR3, 
		       DATE_FORMAT(b.REG_DT,'%x-%m-%d') AS REG_DT,
		       CASE WHEN b.FILE_ID IS NOT NULL THEN '등록'
					ELSE '미등록' END AS FILE_CHK,
		       CASE WHEN b.EDU_CON_URL IS NOT NULL THEN '등록'
					ELSE '미등록' END AS URL_CHK
		FROM EDU_REGISTRATION a,
			 EDU_REGISTRATION_DETAIL b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.EDU_SITE = 'on'
	      <if test=" category1_key !=null and category1_key != '' and searchCondition == 'CATEGORY'">
			AND a.CATEGORY1_KEY = #{category1_key} 
		</if>
		<if test=" category2_key !=null and category2_key != '' and searchCondition == 'CATEGORY'">
			AND a.CATEGORY2_KEY = #{category2_key} 
		</if>
		<if test=" category3_key !=null and category3_key != '' and searchCondition == 'CATEGORY'">
			AND a.CATEGORY3_KEY = #{category3_key} 
		</if>
	      <![CDATA[
	      <if test="edu_status != null and edu_status == '1'">
	      	AND b.TRAIN_S_DATE > NOW()
	      </if>
	      <if test="edu_status != null and edu_status == '2'">
	      	AND b.TRAIN_S_DATE <= NOW() AND b.TRAIN_E_DATE >= NOW()
	      </if>
	      <if test="edu_status != null and edu_status == '3'">
	      	AND b.TRAIN_E_DATE > NOW()
	      </if>
	       ]]>
	      <if test="con_chk != null and con_chk == '1'">
	      	AND b.FILE_ID IS NOT NULL
	      </if>
	      <if test="con_chk != null and con_chk == '2'">
	      	AND b.FILE_ID IS NULL
	      </if>
	      <if test="searchDate !=null and searchDate != 'ALL'">
	      	<![CDATA[
		       AND b.TRAIN_S_DATE >= #{start_date} AND b.TRAIN_E_DATE <= #{end_date} 
	        ]]>
	      </if>
	     ORDER BY EDU_SUB_NO DESC
	    LIMIT #{recordCountPerPage}  OFFSET  #{offset}		
	</select>


	<select id="contentsListCnt" parameterType="java.util.Map" resultType="int">
    	/**  com.easycompany.mapper.LmsMapper.contentsListCnt **/
		 SELECT COUNT(*) cnt
	       FROM edu_lms
	     WHERE USE_YN = 'Y'
	      <if test="searchCondition !=null and searchCondition == 'ALL'">
	      	AND (TITLE LIKE CONCAT('%', #{searchKeyword}, '%') OR REG_ID LIKE CONCAT('%', #{searchKeyword}, '%') OR CONTENTS LIKE CONCAT('%', #{searchKeyword}, '%'))
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'TITLE'">
	      	AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'REG_NM'">
	      	AND REG_ID LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'CONTENTS'">
	      	AND CONTENTS LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchDate !=null and searchDate != 'ALL'">
	      	<![CDATA[
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) >= #{start_date} AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) <= #{end_date} 
	        ]]>
	      </if>
	      <if test="edu_status !=null and edu_status != 'ALL'">
	      	AND EDU_STATUS = #{edu_status}
	      </if>
	</select>
	
	<select id="selectDetailLms" parameterType="java.util.Map" resultType="java.util.Map">
		/**  com.easycompany.mapper.LmsMapper.selectDetailLms **/	
		SELECT CONTENT_IDX, CATEGORY1_KEY, CATEGORY2_KEY, CATEGORY3_KEY, CATEGORY1_NAME, CATEGORY2_NAME, CATEGORY3_NAME, LMS_CNT,
	    LMS_TITLE, EDU_TIME, EDU_TIME_CF, CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d %H:%i:%s' ) AS CHAR(19) ) AS REG_DT, REG_ID, EDU_STATUS
	      FROM edu_lms
	      WHERE CONTENT_IDX = #{content_idx}
	    	AND USE_YN = 'Y'
	</select>
	
	<insert id="insertContents" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="content_idx">
		/**  com.easycompany.mapper.LmsMapper.insertContents **/	
		INSERT 
		INTO edu_lms
		(
	      	 CATEGORY1_KEY
	      	, CATEGORY2_KEY
	      	, CATEGORY3_KEY
	      	, CATEGORY1_NAME
	      	, CATEGORY2_NAME
	      	, CATEGORY3_NAME
	      	, LMS_CNT
	      	, LMS_TITLE
	      	, EDU_TIME
	      	, EDU_TIME_CF
	      	, EDU_STATUS
	      	, REG_ID
		) 
		VALUES 
		(
			 #{category1_key}
			, #{category2_key}
			, #{category3_key}
			, #{category1_name}
			, #{category2_name}
			, #{category3_name}
			, #{lms_cnt}
			, #{lms_title}
			, #{edu_time}
			, #{edu_time_cf}
			, #{edu_status}
			, IFNULL(#{reg_id},'SYSTEM')
		)	
	</insert>
	
	<update id="updateContents" parameterType="java.util.Map">
		/**  com.easycompany.mapper.LmsMapper.updateContents **/	
		UPDATE edu_lms 
		   SET LMS_CNT = #{lms_cnt}
	      	, CATEGORY1_KEY =  #{category1_key}
	      	, CATEGORY2_KEY =  #{category2_key}
	      	, CATEGORY3_KEY =  #{category3_key}
	      	, CATEGORY1_NAME = #{category1_name}
	      	, CATEGORY2_NAME = #{category2_name}
	      	, CATEGORY3_NAME = #{category3_name}
	      	, LMS_TITLE = #{lms_title}
	      	, EDU_TIME = #{edu_time}
	      	, EDU_TIME_CF = #{edu_time_cf}
	      	, EDU_STATUS = #{edu_status}
	      	, CHG_DT = date_format(current_timestamp(),'%Y%m%d%H%i%s')
		    , CHG_ID = IFNULL(#{chg_id},'SYSTEM')
		    , REG_ID = IFNULL(#{reg_id},'SYSTEM')
 		 WHERE CONTENT_IDX = #{content_idx}
	</update>
	                  
	<insert id="insertLmsFile" parameterType="java.util.HashMap">
		/**  com.easycompany.mapper.LmsMapper.insertLmsFile **/	
		<selectKey resultType="int" keyProperty="file_seq" order="BEFORE">			
			SELECT IFNULL(MAX(FILE_SEQ), 0) + 1 
			  FROM EDU_FILE			  
		</selectKey>		
		INSERT 
		INTO EDU_FILE
		(
		  	  FILE_GUBUN
		  	, FILE_ID
		  	, FILE_NAME
		  	, FILE_FULL_PATH
		  	, FILE_SEQ
		  	, FILE_SIZE
		  	, FILE_KEY
		  	, FILE_OREDER_BY
		) 
		VALUES 
		(
			  #{file_gubun}
			, #{file_uuid}
			, #{file_name}
			, #{file_full_path}
			, #{file_seq}
			, #{file_size}
			, #{file_key}
			, #{file_oreder_by}
			
		)	
	</insert>
	
	<select id="selectFileList" parameterType="java.util.Map" resultType="java.util.Map">
		/**  com.easycompany.mapper.LmsMapper.selectFileList **/	
		SELECT FILE_GUBUN, FILE_ID, FILE_NAME, FILE_FULL_PATH, FILE_SEQ, FILE_ID, FILE_SIZE, FILE_KEY, FILE_OREDER_BY
	      FROM edu_file
	    WHERE FILE_KEY = #{board_idx}
	    	AND FILE_GUBUN = 'board'
	</select>
	
	<select id="selectFile" parameterType="java.util.Map" resultType="java.util.Map">
		/**  com.easycompany.mapper.LmsMapper.selectFile **/	
		SELECT FILE_GUBUN, FILE_ID, FILE_NAME, FILE_FULL_PATH, FILE_SEQ, FILE_ID, FILE_SIZE, FILE_KEY, FILE_OREDER_BY
	      FROM edu_file
	    WHERE FILE_SEQ = #{file_seq}
	</select>
		
</mapper>
