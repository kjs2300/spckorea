<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.easycompany.mapper.OrgMapper">
	<select id="getOrgList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  a.EDU_NO,
				(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = a.CATEGORY3_KEY) AS CATEGORY3_NAME,
		        a.COPER_NM_AUTO,
		        a.EDU_TARGET,
		        a.EDU_TIME,
		        a.EDU_GARDEN,
		        a.EDU_STATUS
		FROM EDU_REGISTRATION a
		WHERE EDU_SITE = 'off'
		AND CATEGORY1_KEY = '7'
		AND CATEGORY2_KEY = '14'
		AND EXP_USE_YN = 'Y'
		<choose>
			<when test="searchType !=null and searchType !='' and searchType =='coper' ">
				AND COPER_NM_AUTO LIKE CONCAT('%', #{searchText}, '%')
			</when>
			<when test="searchType !=null and searchType !='' and searchType =='edu' ">
				AND CATEGORY3_KEY IN (SELECT CATEGORY3_KEY FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%', #{searchText}, '%'))
			</when>
		</choose>
		
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>

	<select id="getOrgListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_REGISTRATION a
		WHERE EDU_SITE = 'off'
		AND CATEGORY1_KEY = '7'
		AND CATEGORY2_KEY = '14'
		AND EXP_USE_YN = 'Y'
		<choose>
			<when test="searchType !=null and searchType !='' and searchType =='coper' ">
				AND COPER_NM_AUTO LIKE CONCAT('%', #{searchText}, '%')
			</when>
			<when test="searchType !=null and searchType !='' and searchType =='edu' ">
				AND CATEGORY3_KEY IN (SELECT CATEGORY3_KEY FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%', #{searchText}, '%'))
			</when>
		</choose>
	</select>
	
	<select id="getOrgView" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT  ER.EDU_NO, IFNULL(ER.COPER_NM,ER.COPER_NM_AUTO) AS COPER_NM,
			(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = ER.CATEGORY3_KEY) AS CATEGORY3 , 
			ER.EDU_TIME, ER.EDU_GARDEN, ER.EDU_TARGET,
			ER.EDU_TARGET, ER.EDU_STATUS
		FROM EDU_REGISTRATION ER
        WHERE 1=1
        AND EDU_SITE = 'off'
		AND CATEGORY1_KEY = '7'
		AND CATEGORY2_KEY = '14'
		AND EXP_USE_YN = 'Y'
        AND EDU_NO = ${edu_no}
	</select>
	
	<select id="getInsSearch" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.INSTRUCTOR_IDX,
			  (SELECT CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '32' AND CD = b.AREA_CD) AS AREA_NM,
			  b.USER_NM,
              b.COPER_NM
		 FROM EDU_INSTRUCTOR a,
			  COM_USER b
		WHERE 1=1
        AND a.COM_USER_ID = b.USER_ID
        AND a.STATUS = 1
        AND a.USE_YN = 'Y'
        <if test="area_nm !=null and area_nm != ''">
	      	AND b.AREA_CD = ${area_nm}
	      </if>
	      <if test="ins_nm !=null and ins_nm != ''">
	      	AND b.USER_NM LIKE CONCAT('%', #{ins_nm}, '%')
	      </if>
	      <if test="coper_nm !=null and coper_nm != ''">
	      	AND b.COPER_NM LIKE CONCAT('%', #{coper_nm}, '%')
	      </if>
	</select>
	
	<insert id="basketInsert" parameterType="java.util.Map">	
		INSERT INTO EDU_BASKET(
		  	  BASKET_NO
		  	, EDU_NO
		  	, USER_ID
		  	, USER_NM
		  	, REG_ID
		) VALUES (
			  (SELECT MAX(a.BASKET_NO)+1 FROM EDU_BASKET a)
			, #{edu_no}
			, #{UserAccount.user_id}
			, #{UserAccount.user_nm}
			, #{UserAccount.user_id}
		)	
	</insert>
	
	<select id="getRegistCheck" parameterType="java.util.Map" resultType="int">
	SELECT  COUNT(COUR_NO)
		FROM EDU_COURSE_REGISTRATION
		 WHERE 1=1
		AND EDU_NO = ${edu_no}
        AND USER_ID = #{UserAccount.user_id}
	</select>
	
	<insert id="registInsert" parameterType="java.util.Map">	
		INSERT INTO EDU_COURSE_REGISTRATION(
		  	  COUR_NO
		  	, EDU_NO
		  	, USER_ID
		  	, USER_NM
		  	, EML_ADDR
		  	, MBL_TELNO
		  	, REG_ID
		) VALUES (
			  (SELECT MAX(a.COUR_NO)+1 FROM EDU_COURSE_REGISTRATION a)
			, #{edu_no}
			, #{UserAccount.user_id}
			, #{UserAccount.user_nm}
			, CONCAT(#{eml_addr1},'@',#{eml_addr2})
			, #{mbl_telno}
			, #{UserAccount.user_id}
		)	
	</insert>
</mapper>
