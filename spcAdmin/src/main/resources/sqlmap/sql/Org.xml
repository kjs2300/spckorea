<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.easycompany.mapper.OrgMapper">
	<select id="getOrgList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  a.EDU_NO,
				(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = a.CATEGORY3_KEY) AS CATEGORY3_NAME,
		        a.COPER_NM_AUTO,
		        a.EDU_TARGET,
		        a.EDU_TIME,
		        a.EDU_GARDEN,
		        a.EDU_STATUS
		FROM EDU_REGISTRATION a
		WHERE EDU_SITE = 'off'
		AND CATEGORY1_KEY = '7'
		AND CATEGORY2_KEY = '14'
		AND EXP_USE_YN = 'Y'
		<choose>
			<when test="searchType !=null and searchType !='' and searchType =='coper' ">
				AND COPER_NM_AUTO LIKE CONCAT('%', #{searchText}, '%')
			</when>
			<when test="searchType !=null and searchType !='' and searchType =='edu' ">
				AND CATEGORY3_KEY IN (SELECT CATEGORY3_KEY FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%', #{searchText}, '%'))
			</when>
		</choose>
		
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>

	<select id="getOrgListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_REGISTRATION a
		WHERE EDU_SITE = 'off'
		AND CATEGORY1_KEY = '7'
		AND CATEGORY2_KEY = '14'
		AND EXP_USE_YN = 'Y'
		<choose>
			<when test="searchType !=null and searchType !='' and searchType =='coper' ">
				AND COPER_NM_AUTO LIKE CONCAT('%', #{searchText}, '%')
			</when>
			<when test="searchType !=null and searchType !='' and searchType =='edu' ">
				AND CATEGORY3_KEY IN (SELECT CATEGORY3_KEY FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%', #{searchText}, '%'))
			</when>
		</choose>
	</select>
	
	<select id="getOrgView" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT  ER.EDU_NO, (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = ER.CATEGORY1_KEY) AS CATEGORY1 , 
			(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = ER.CATEGORY2_KEY) AS CATEGORY2 , 
			(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = ER.CATEGORY3_KEY) AS CATEGORY3 , 
			ER.INST_NM, ER.TRAIN_S_DATE, ER.TRAIN_E_DATE, ER.EDU_METHOD,ER.EDU_TIME, ER.EDU_NOTICE,
            ERD.EDU_INTRO, ERD.EDU_GOALS, ERD.EDU_CURR1, ERD.EDU_CURR2, ERD.EDU_CURR3,
            ER.EDU_TARGET, ER.EDU_STATUS
		FROM EDU_REGISTRATION ER LEFT OUTER JOIN
			 EDU_REGISTRATION_DETAIL ERD  
		ON ER.EDU_NO = ERD.EDU_NO
		 WHERE 1=1
        AND ER.EDU_NO = ${edu_no}
	</select>
	
	<select id="getBasketCheck" parameterType="java.util.Map" resultType="int">
	SELECT  COUNT(BASKET_NO)
		FROM EDU_BASKET
		 WHERE 1=1
		AND EDU_NO = ${edu_no}
        AND USER_ID = #{UserAccount.user_id}
	</select>
	
	<insert id="basketInsert" parameterType="java.util.Map">	
		INSERT INTO EDU_BASKET(
		  	  BASKET_NO
		  	, EDU_NO
		  	, USER_ID
		  	, USER_NM
		  	, REG_ID
		) VALUES (
			  (SELECT MAX(a.BASKET_NO)+1 FROM EDU_BASKET a)
			, #{edu_no}
			, #{UserAccount.user_id}
			, #{UserAccount.user_nm}
			, #{UserAccount.user_id}
		)	
	</insert>
	
	<select id="getRegistCheck" parameterType="java.util.Map" resultType="int">
	SELECT  COUNT(COUR_NO)
		FROM EDU_COURSE_REGISTRATION
		 WHERE 1=1
		AND EDU_NO = ${edu_no}
        AND USER_ID = #{UserAccount.user_id}
	</select>
	
	<insert id="registInsert" parameterType="java.util.Map">	
		INSERT INTO EDU_COURSE_REGISTRATION(
		  	  COUR_NO
		  	, EDU_NO
		  	, USER_ID
		  	, USER_NM
		  	, EML_ADDR
		  	, MBL_TELNO
		  	, REG_ID
		) VALUES (
			  (SELECT MAX(a.COUR_NO)+1 FROM EDU_COURSE_REGISTRATION a)
			, #{edu_no}
			, #{UserAccount.user_id}
			, #{UserAccount.user_nm}
			, CONCAT(#{eml_addr1},'@',#{eml_addr2})
			, #{mbl_telno}
			, #{UserAccount.user_id}
		)	
	</insert>
</mapper>
